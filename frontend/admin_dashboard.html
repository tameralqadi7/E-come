<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ¬Ø±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script>
        // [ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØªØ¨Ø©]
        const token = localStorage.getItem('user_token');
        if (!token) {
            window.location.href = 'login.html';
        } else {
            try {
                // ÙÙƒ Ø§Ù„ØªÙˆÙƒÙ† ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù€ Role
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (payload.role !== 'Admin') {
                    alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ù„Ù…ØªØ¬Ø±.");
                    window.location.href = 'shop.html';
                }
            } catch (e) {
                localStorage.removeItem('user_token');
                window.location.href = 'login.html';
            }
        }
    </script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark shadow mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± ğŸ› ï¸</span>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Ø®Ø±ÙˆØ¬ Ø¢Ù…Ù†</button>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="card p-4 shadow-sm text-center mb-4">
            <h2 id="welcomeMsg">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <p class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…ØªØ¬Ø±.</p>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Ø¥Ø¯Ø§Ø±Ø© ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Categories)</h5>
            </div>
            <div class="card-body">
                <div class="input-group mb-4">
                    <input type="hidden" id="categoryId"> <input type="text" id="categoryName" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù...">
                    <button id="btnSave" class="btn btn-success" onclick="saveCategory()">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                    <button id="btnCancel" class="btn btn-secondary d-none" onclick="resetForm()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover text-center">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // [ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬]
        function logout() {
            localStorage.removeItem('user_token'); 
            window.location.href = 'login.html';
        }

        // [ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯]

        // 1. Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† get_categories.php ÙˆØ¹Ø±Ø¶Ù‡Ø§
        async function loadCategories() {
            try {
                const response = await fetch('../backend/get_categories.php');
                const categories = await response.json();
                
                const tableBody = document.getElementById('categoriesTableBody');
                tableBody.innerHTML = '';

                categories.forEach((cat, index) => {
                    tableBody.innerHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${cat.name}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="prepareUpdate(${cat.id}, '${cat.name}')">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id})">Ø­Ø°Ù</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£ØµÙ†Ø§Ù:", error);
            }
        }

        // 2. Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù (ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù…Ù„Ù manage_categories.php)
        async function saveCategory() {
            const id = document.getElementById('categoryId').value;
            const name = document.getElementById('categoryName').value;
            const action = id ? 'update' : 'create';

            if (!name) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù"); return; }

            const response = await fetch('../backend/manage_categories.php', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('user_token') 
                },
                body: JSON.stringify({ action: action, id: id, name: name })
            });

            const result = await response.json();
            if (result.status === 'success') {
                resetForm();
                loadCategories(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
            } else {
                alert(result.message);
            }
        }

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù
        async function deleteCategory(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ')) {
                const response = await fetch('../backend/manage_categories.php', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('user_token') 
                    },
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                const result = await response.json();
                if (result.status === 'success') { 
                    loadCategories(); 
                }
            }
        }

        // ÙˆØ¸Ø§Ø¦Ù ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ù„ØºØ§Ø¡)
        function prepareUpdate(id, name) {
            document.getElementById('categoryId').value = id;
            document.getElementById('categoryName').value = name;
            document.getElementById('btnSave').innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
            document.getElementById('btnSave').className = 'btn btn-warning';
            document.getElementById('btnCancel').classList.remove('d-none');
        }

        function resetForm() {
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryName').value = '';
            document.getElementById('btnSave').innerText = 'Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù';
            document.getElementById('btnSave').className = 'btn btn-success';
            document.getElementById('btnCancel').classList.add('d-none');
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ù„Ø¨ ÙÙˆØ± ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', loadCategories);
    </script>
</body>
</html>